From 31316d494d3058e2503045d7042fb9915fbab9cb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ji=C5=99=C3=AD=20Moravec?= <qjim@volny.cz>
Date: Wed, 30 Jul 2025 01:58:02 +0300
Subject: [PATCH 05/26] [ffmpeg] fix build against libav-9

Bug: https://bugs.gentoo.org/443214
Origin: https://github.com/gentoo/gentoo-historical-2/commit/11c55e121226f9bb5b5a24a26d69e52f09559f83
Patch-name: transcode-1.1.7-libav-9.patch
Signed-off-by: Alexander Golubev <fatzer2@gmail.com>
---
 import/decode_lavc.c  | 4 ++--
 import/probe_ffmpeg.c | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/import/decode_lavc.c b/import/decode_lavc.c
index 456a410d..7af7067b 100644
--- a/import/decode_lavc.c
+++ b/import/decode_lavc.c
@@ -170,7 +170,7 @@ void decode_lavc(decode_t *decode)
 
   // Set these to the expected values so that ffmpeg's decoder can
   // properly detect interlaced input.
-  lavc_dec_context = avcodec_alloc_context();
+  lavc_dec_context = avcodec_alloc_context3(NULL);
   if (lavc_dec_context == NULL) {
       tc_log_error(__FILE__, "Could not allocate enough memory.");
       goto decoder_error;
@@ -186,7 +186,7 @@ void decode_lavc(decode_t *decode)
   lavc_dec_context->error_concealment = 3;
   lavc_dec_context->workaround_bugs = FF_BUG_AUTODETECT;
 
-  if (avcodec_open(lavc_dec_context, lavc_dec_codec) < 0) {
+  if (avcodec_open2(lavc_dec_context, lavc_dec_codec, NULL) < 0) {
       tc_log_error(__FILE__, "Could not initialize the '%s' codec.",
 		   codec->name);
       goto decoder_error;
diff --git a/import/probe_ffmpeg.c b/import/probe_ffmpeg.c
index bfa0fa92..bb2ad24a 100644
--- a/import/probe_ffmpeg.c
+++ b/import/probe_ffmpeg.c
@@ -109,7 +109,7 @@ void probe_ffmpeg(info_t *ipipe)
         return;
     }
 
-    ret = av_find_stream_info(lavf_dmx_context);
+    ret = avformat_find_stream_info(lavf_dmx_context, NULL);
     if (ret < 0) {
         tc_log_error(__FILE__, "unable to fetch informations from '%s'"
                                " (libavformat failure)",
-- 
2.49.1

